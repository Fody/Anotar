image: Visual Studio 2017

install:
  - choco install gitversion.portable -pre -y

before_build:
  - nuget restore Anotar.sln
  - dotnet restore Anotar.NetStandard.sln
  - ps: gitversion /l console /output buildserver /updateassemblyinfo

configuration: Release

build:
  project: Anotar.sln
  verbosity: minimal

after_build:
  - ps: Get-ChildItem -Recurse -Filter Custom*.csproj | % { dotnet build $_.FullName -c $env:CONFIGURATION }
  - ps: Get-ChildItem -Recurse -Filter Custom*.csproj | % { dotnet pack $_.FullName -c $env:CONFIGURATION -o ../NuGetBuild /p:Version=$env:GitVersion_NuGetVersion }

test:
  assemblies:
    except:
      - CustomTests.dll
      - Xunit.SkippableFact.dll

after_test:
  - ps: | 
      Get-ChildItem -Recurse -Filter CustomTests.csproj | %{ 
         Push-Location $_.Directory; 
         dotnet xunit -configuration $env:CONFIGURATION;
         if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode)  };
         Pop-Location 
      }

artifacts:
  - path: 'NuGetBuild\*.nupkg'
